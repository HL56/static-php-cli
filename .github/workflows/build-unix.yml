name: "CI on Unix"

on:
  workflow_dispatch:
    inputs:
      os:
        required: true
        description: Build target OS
        default: 'linux-x86_64'
        type: choice
        options:
          - 'linux-x86_64'
          - 'linux-aarch64'
          - 'linux-x86_64-glibc'
          - 'linux-aarch64-glibc'
          - 'macos-x86_64'
          - 'macos-aarch64'
      php-version:
        required: true
        description: PHP version to compile
        default: '8.4'
        type: choice
        options:
          - '8.4'
          - '8.3'
          - '8.2'
          - '8.1'
      extensions:
        description: Extensions to build (comma separated)
        required: true
        type: string
      extra-libs:
        description: Extra libraries to build (optional, comma separated)
        type: string
      build-cli:
        description: Build cli binary
        default: true
        type: boolean
      build-micro:
        description: Build phpmicro binary
        type: boolean
      build-fpm:
        description: Build fpm binary
        type: boolean
      prefer-pre-built:
        description: Prefer pre-built binaries (reduce build time)
        type: boolean
        default: true
      debug:
        description: Show full build logs
        type: boolean
      no-strip:
        description: Keep debug symbols for debugging
        type: boolean
        default: false
      use-self-hosted:
        description: Run build job on self-hosted runner
        type: boolean
        default: false
  workflow_call:
    inputs:
      os:
        required: true
        description: Build target OS
        default: 'linux-x86_64'
        type: string
      php-version:
        required: true
        description: PHP version to compile
        default: '8.4'
        type: string
      extensions:
        description: Extensions to build (comma separated)
        required: true
        type: string
      extra-libs:
        description: Extra libraries to build (optional, comma separated)
        type: string
      build-cli:
        description: Build cli binary
        default: true
        type: boolean
      build-micro:
        description: Build phpmicro binary
        type: boolean
      build-fpm:
        description: Build fpm binary
        type: boolean
      prefer-pre-built:
        description: Prefer pre-built binaries (reduce build time)
        type: boolean
        default: true
      debug:
        description: Show full build logs
        type: boolean
      no-strip:
        description: Keep debug symbols for debugging
        type: boolean
        default: false
      use-self-hosted:
        description: Run build job on self-hosted runner
        type: boolean
        default: true

env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  define-build:
    name: "Define Build Scripts"
    runs-on: ubuntu-latest
    outputs:
      run: ${{ steps.gendef.outputs.run }}
      download: ${{ steps.gendef.outputs.download }}
      build: ${{ steps.gendef.outputs.build }}
      xdebug: ${{ steps.gendef.outputs.xdebug }}
    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Define"
        id: gendef
        run: |
          case "${{ inputs.os }}" in
            linux-x86_64)
              DOWN_CMD="./bin/spc-alpine-docker download"
              BUILD_CMD="./bin/spc-alpine-docker build"
              RUNS_ON='"ubuntu-latest"'
              ;;
            linux-aarch64)
              DOWN_CMD="./bin/spc-alpine-docker download"
              BUILD_CMD="./bin/spc-alpine-docker build"
              RUNS_ON='"ubuntu-24.04-arm"'
              ;;
            linux-x86_64-glibc)
              DOWN_CMD="./bin/spc-gnu-docker download"
              BUILD_CMD="./bin/spc-gnu-docker build"
              RUNS_ON='"ubuntu-22.04"'
              ;;
            linux-aarch64-glibc)
              DOWN_CMD="./bin/spc-gnu-docker download"
              BUILD_CMD="./bin/spc-gnu-docker build"
              RUNS_ON='"ubuntu-22.04-arm"'
              ;;
            macos-x86_64)
              DOWN_CMD="composer update --no-dev --classmap-authoritative && ./bin/spc doctor --auto-fix && ./bin/spc download"
              BUILD_CMD="./bin/spc build"
              RUNS_ON='"macos-15-intel"'
              ;;
            macos-aarch64)
              DOWN_CMD="composer update --no-dev --classmap-authoritative && ./bin/spc doctor --auto-fix && ./bin/spc download"
              BUILD_CMD="./bin/spc build"
              RUNS_ON='"macos-15"'
              ;;
          esac

          if [ ${{ inputs.use-self-hosted }} == true ]; then
            case "${{ inputs.os }}" in
              linux-x86_64|linux-x86_64-glibc)
                RUNS_ON='["self-hosted","Linux","X64"]'
                ;;
              linux-aarch64|linux-aarch64-glibc)
                RUNS_ON='["self-hosted","Linux","ARM64"]'
                ;;
              macos-x86_64)
                RUNS_ON='["self-hosted","macOS","X64"]'
                ;;
              macos-aarch64)
                RUNS_ON='["self-hosted","macOS","ARM64"]'
                ;;
            esac
          fi

          EXTENSIONS_RAW="${{ inputs.extensions }}"
          EXTENSIONS="$(echo "$EXTENSIONS_RAW" | tr -d '[:space:]')"
          PHP_VERSION="${{ inputs.php-version }}"
          if [[ "$PHP_VERSION" == "git" ]]; then
            PHP_SRC_REV="master"
          elif [[ "$PHP_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            PHP_SRC_REV="php-${PHP_VERSION}"
          else
            PHP_SRC_REV="PHP-${PHP_VERSION}"
          fi
          SHARED_EXTENSIONS=""
          HAS_XDEBUG=false
          STATIC_EXTENSIONS="$EXTENSIONS"
          if [[ ",$EXTENSIONS," == *",xdebug,"* ]]; then
            SHARED_EXTENSIONS="xdebug"
            HAS_XDEBUG=true
            STATIC_EXTENSIONS="$(echo ",$EXTENSIONS," | sed -E 's/,xdebug,/,/g; s/^,//; s/,$//; s/,+/,/g')"
          fi

          if [ -z "$STATIC_EXTENSIONS" ]; then
            echo "Error: xdebug is shared-only, please provide at least one static extension." >&2
            exit 1
          fi

          # xdebug shared build on Linux requires a dynamic/glibc target.
          if [ "$HAS_XDEBUG" = true ]; then
            case "${{ inputs.os }}" in
              linux-x86_64)
                DOWN_CMD="./bin/spc-gnu-docker download"
                BUILD_CMD="./bin/spc-gnu-docker build"
                ;;
              linux-aarch64)
                DOWN_CMD="./bin/spc-gnu-docker download"
                BUILD_CMD="./bin/spc-gnu-docker build"
                if [ ${{ inputs.use-self-hosted }} != true ]; then
                  RUNS_ON='"ubuntu-22.04-arm"'
                fi
                ;;
            esac
          fi

          DOWN_CMD="$DOWN_CMD --with-php=${{ inputs.php-version }} --for-extensions=$EXTENSIONS --ignore-cache-sources=php-src --custom-git=php-src:${PHP_SRC_REV}:https://github.com/php/php-src.git"
          BUILD_CMD="$BUILD_CMD $STATIC_EXTENSIONS"
          if [ -n "$SHARED_EXTENSIONS" ]; then
            BUILD_CMD="$BUILD_CMD --build-shared=$SHARED_EXTENSIONS"
          fi
          if [ -n "${{ inputs.extra-libs }}" ]; then
            DOWN_CMD="$DOWN_CMD --for-libs=${{ inputs.extra-libs }}"
            BUILD_CMD="$BUILD_CMD --with-libs=${{ inputs.extra-libs }}"
          fi
          if [ ${{ inputs.debug }} == true ]; then
            DOWN_CMD="$DOWN_CMD --debug"
            BUILD_CMD="$BUILD_CMD --debug"
          fi
          if [ ${{ inputs.prefer-pre-built }} == true ]; then
              DOWN_CMD="$DOWN_CMD --prefer-pre-built"
          fi
          if [ ${{ inputs.build-cli }} == true ]; then
              BUILD_CMD="$BUILD_CMD --build-cli"
          fi
          if [ ${{ inputs.build-micro }} == true ]; then
              BUILD_CMD="$BUILD_CMD --build-micro"
          fi
          if [ ${{ inputs.build-fpm }} == true ]; then
              BUILD_CMD="$BUILD_CMD --build-fpm"
          fi
          echo 'download='"$DOWN_CMD" >> "$GITHUB_OUTPUT"
          echo 'build='"$BUILD_CMD" >> "$GITHUB_OUTPUT"
          echo 'run='"$RUNS_ON" >> "$GITHUB_OUTPUT"
          echo 'xdebug='"$HAS_XDEBUG" >> "$GITHUB_OUTPUT"
  build:
    name: "Build ${{ inputs.version }} on ${{ inputs.os }}"
    runs-on: ${{ fromJSON(needs.define-build.outputs.run) }}
    needs: define-build
    timeout-minutes: 240
    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Setup PHP"
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.4
          tools: pecl, composer
          extensions: curl, openssl, mbstring
          ini-values: memory_limit=-1
        env:
          phpts: nts

      # Cache downloaded source
      - id: cache-download
        uses: actions/cache@v4
        with:
          path: downloads
          key: php-dependencies-${{ inputs.os }}
      - name: "Download sources"
        run: ${{ needs.define-build.outputs.download }}
      - name: "Build PHP"
        run: ${{ needs.define-build.outputs.build }}

      - name: "Show SPC logs on failure"
        if: failure()
        run: |
          echo "===== log/spc.output.log (tail -n 200) ====="
          tail -n 200 log/spc.output.log || true
          echo "===== log/spc.shell.log (tail -n 200) ====="
          tail -n 200 log/spc.shell.log || true

      - name: "Upload SPC logs"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ inputs.php-version }}-${{ inputs.os }}
          path: |
            log/spc.output.log
            log/spc.shell.log
          if-no-files-found: ignore
#      - name: Setup tmate session
#        if: ${{ failure() }}
#        uses: mxschmitt/action-tmate@v3

      # Upload cli executable
      - if: ${{ inputs.build-cli == true }}
        name: "Upload PHP cli SAPI"
        uses: actions/upload-artifact@v4
        with:
          name: php-cli-${{ inputs.php-version }}-${{ inputs.os }}
          path: buildroot/bin/php

      # Upload micro self-extracted executable
      - if: ${{ inputs.build-micro == true }}
        name: "Upload PHP micro SAPI"
        uses: actions/upload-artifact@v4
        with:
          name: php-micro-${{ inputs.php-version }}-${{ inputs.os }}
          path: buildroot/bin/micro.sfx

      # Upload fpm executable
      - if: ${{ inputs.build-fpm == true }}
        name: "Upload PHP fpm SAPI"
        uses: actions/upload-artifact@v4
        with:
          name: php-fpm-${{ inputs.php-version }}-${{ inputs.os }}
          path: buildroot/bin/php-fpm

      # Upload shared xdebug module when requested
      - if: ${{ needs.define-build.outputs.xdebug == 'true' }}
        name: "Upload Xdebug Shared Module"
        uses: actions/upload-artifact@v4
        with:
          name: php-xdebug-${{ inputs.php-version }}-${{ inputs.os }}
          path: buildroot/modules/xdebug.so

      # Upload extensions metadata
      - uses: actions/upload-artifact@v4
        name: "Upload License Files"
        with:
          name: license-files-${{ inputs.php-version }}-${{ inputs.os }}
          path: buildroot/license/
      - uses: actions/upload-artifact@v4
        name: "Upload Build Metadata"
        with:
          name: build-meta-${{ inputs.php-version }}-${{ inputs.os }}
          path: |
            buildroot/build-extensions.json
            buildroot/build-libraries.json
