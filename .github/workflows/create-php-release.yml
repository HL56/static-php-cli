name: Create PHP Release

on:
  workflow_dispatch:
    inputs:
      php-version:
        description: "PHP version to compile and release (e.g., 8.4.13)"
        required: true
        type: string
      extensions:
        description: "Extensions to build (comma separated)"
        required: true
        type: string
      extra-libs:
        description: "Extra libraries to build (optional, comma separated)"
        required: false
        type: string
      prefer-pre-built:
        description: "Prefer pre-built binaries (reduce build time)"
        default: true
        type: boolean
      debug:
        description: "Show full build logs"
        default: false
        type: boolean
      no-strip:
        description: "Keep debug symbols for debugging"
        default: false
        type: boolean
      build-frankenphp:
        description: "Build and release FrankenPHP binaries"
        default: false
        type: boolean

jobs:
  validate-inputs:
    name: Validate build inputs
    runs-on: ubuntu-latest
    steps:
      - name: Validate extension compatibility
        run: |
          set -euo pipefail
          VERSION="${{ inputs.php-version }}"
          EXTENSIONS_RAW="${{ inputs.extensions }}"
          EXTENSIONS="$(echo "$EXTENSIONS_RAW" | tr -d '[:space:]')"
          EXTS=",${EXTENSIONS},"

          has_ext() {
            [[ "$EXTS" == *",$1,"* ]]
          }

          version_major_minor="$(echo "$VERSION" | awk -F. '{print $1 "." $2}')"
          fail=0

          # ext-imap was dropped from PHP 8.4+
          if [ "$(printf '%s\n' "8.4" "$version_major_minor" | sort -V | head -n1)" = "8.4" ] && has_ext "imap"; then
            echo "Error: 'imap' is not supported for PHP ${VERSION} (PHP >= 8.4)."
            echo "Please remove 'imap' from extensions or use PHP < 8.4."
            fail=1
          fi

          # Known conflicts from extension notes
          if has_ext "swoole-hook-pgsql" && has_ext "pdo_pgsql"; then
            echo "Error: 'swoole-hook-pgsql' conflicts with 'pdo_pgsql'."
            fail=1
          fi
          if has_ext "swoole-hook-sqlite" && has_ext "pdo_sqlite"; then
            echo "Error: 'swoole-hook-sqlite' conflicts with 'pdo_sqlite'."
            fail=1
          fi
          if has_ext "swoole-hook-odbc" && has_ext "pdo_odbc"; then
            echo "Error: 'swoole-hook-odbc' conflicts with 'pdo_odbc'."
            fail=1
          fi

          if [ "${{ inputs.build-frankenphp }}" = "true" ] && ! has_ext "xml"; then
            echo "Error: FrankenPHP build requires 'xml' extension (libxml2)."
            fail=1
          fi

          if [ "$fail" -ne 0 ]; then
            exit 1
          fi

  build:
    name: Build ${{ inputs.php-version }} on ${{ matrix.os }}
    needs: validate-inputs
    strategy:
      fail-fast: false
      matrix:
        os:
          - linux-x86_64
          - linux-aarch64
          - macos-x86_64
          - macos-aarch64
    uses: ./.github/workflows/build-unix.yml
    secrets: inherit
    with:
      os: ${{ matrix.os }}
      php-version: ${{ inputs.php-version }}
      extensions: ${{ inputs.extensions }}
      extra-libs: ${{ inputs.extra-libs }}
      build-cli: true
      build-micro: false
      build-fpm: true
      build-frankenphp: ${{ inputs.build-frankenphp }}
      prefer-pre-built: ${{ inputs.prefer-pre-built }}
      debug: ${{ inputs.debug }}
      no-strip: ${{ inputs.no-strip }}

  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
    steps:
      - name: Download compiled PHP artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: php-cli-${{ inputs.php-version }}-*
          path: artifacts

      - name: Download compiled PHP-FPM artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: php-fpm-${{ inputs.php-version }}-*
          path: artifacts

      - name: Download compiled FrankenPHP artifacts
        if: ${{ inputs.build-frankenphp == true }}
        uses: actions/download-artifact@v4
        with:
          pattern: php-frankenphp-${{ inputs.php-version }}-*
          path: artifacts

      - name: Download compiled Xdebug artifacts
        if: contains(inputs.extensions, 'xdebug')
        uses: actions/download-artifact@v4
        with:
          pattern: php-xdebug-${{ inputs.php-version }}-*
          path: artifacts

      - name: Package release assets
        run: |
          set -euo pipefail
          VERSION="${{ inputs.php-version }}"
          WITH_FRANKENPHP="${{ inputs.build-frankenphp }}"
          WITH_XDEBUG="${{ contains(inputs.extensions, 'xdebug') }}"
          TARGETS=(
            "linux-x86_64"
            "linux-aarch64"
            "macos-x86_64"
            "macos-aarch64"
          )

          mkdir -p downloads
          for target in "${TARGETS[@]}"; do
            cli_source_file="artifacts/php-cli-${VERSION}-${target}/php"
            fpm_source_file="artifacts/php-fpm-${VERSION}-${target}/php-fpm"
            if [ ! -f "$cli_source_file" ]; then
              echo "Error: Missing artifact $cli_source_file"
              find artifacts -maxdepth 3 -type f || true
              exit 1
            fi
            if [ ! -f "$fpm_source_file" ]; then
              echo "Error: Missing artifact $fpm_source_file"
              find artifacts -maxdepth 3 -type f || true
              exit 1
            fi

            workdir="pack/${target}"
            mkdir -p "$workdir"

            install -m 755 "$cli_source_file" "$workdir/php"
            install -m 755 "$fpm_source_file" "$workdir/php-fpm"
            tar_items="php php-fpm"

            if [ "$WITH_XDEBUG" = "true" ]; then
              xdebug_source_file="artifacts/php-xdebug-${VERSION}-${target}/xdebug.so"
              if [ ! -f "$xdebug_source_file" ]; then
                echo "Error: Missing artifact $xdebug_source_file"
                find artifacts -maxdepth 3 -type f || true
                exit 1
              fi
              mkdir -p "$workdir/modules"
              install -m 755 "$xdebug_source_file" "$workdir/modules/xdebug.so"
              tar_items="$tar_items modules/xdebug.so"
            fi

            if [ "$WITH_FRANKENPHP" = "true" ]; then
              frankenphp_source_file="artifacts/php-frankenphp-${VERSION}-${target}/frankenphp"
              if [ ! -f "$frankenphp_source_file" ]; then
                echo "Error: Missing artifact $frankenphp_source_file"
                find artifacts -maxdepth 3 -type f || true
                exit 1
              fi
              install -m 755 "$frankenphp_source_file" "$workdir/frankenphp"
              tar_items="$tar_items frankenphp"
            fi

            tar -czf "downloads/php-${VERSION}-${target}.tar.gz" -C "$workdir" $tar_items
            echo "Packed downloads/php-${VERSION}-${target}.tar.gz ($tar_items)"
          done

          ls -la downloads/

      - name: Extract major version
        run: |
          echo "VERSION_MAJOR=$(echo "${{ inputs.php-version }}" | cut -d'.' -f1)" >> "$GITHUB_ENV"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.php-version }}
          name: PHP v${{ inputs.php-version }}
          draft: false
          prerelease: false
          overwrite_files: true
          files: downloads/*.tar.gz
          body: |
            # PHP v${{ inputs.php-version }}

            Extensions: `${{ inputs.extensions }}`

            Changelog: [What's changed in v${{ inputs.php-version }}?](https://www.php.net/ChangeLog-${{ env.VERSION_MAJOR }}.php#${{ inputs.php-version }})

            Targets:
              * linux-x86_64
              * linux-aarch64
              * macos-x86_64
              * macos-aarch64

            Assets:
              * `php-${{ inputs.php-version }}-<target>.tar.gz` (contains `php` and `php-fpm`)
              * If `xdebug` is selected, Unix tarballs also contain `modules/xdebug.so`
              * If `build-frankenphp` is enabled, Unix tarballs also contain `frankenphp`
